<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ByteRush - High Score Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f0ff;
            --neon-pink: #ff0055;
            --neon-yellow: #ffcc00;
        }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Press Start 2P', cursive; touch-action: none; }
        
        #overlay, #death-screen, #pause-screen {
            position: absolute; width: 100%; height: 100%; display: flex; 
            flex-direction: column; justify-content: center; align-items: center; z-index: 1000;
            background: radial-gradient(circle, rgba(0,20,40,0.95) 0%, rgba(0,0,0,1) 100%);
        }

        .menu-card {
            border: 4px solid var(--neon-blue); padding: 40px; text-align: center;
            background: rgba(0, 0, 0, 0.9); box-shadow: 0 0 25px var(--neon-blue);
            max-width: 650px; width: 80%;
        }

        .lang-btns { margin-bottom: 25px; }
        .lang-btn { 
            background: none; border: 2px solid var(--neon-blue); color: var(--neon-blue); 
            padding: 8px 15px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 10px; margin: 0 5px;
        }
        .lang-btn.active { background: var(--neon-blue); color: #000; }

        h1 { 
            font-size: clamp(20px, 8vw, 36px); margin-bottom: 30px;
            background: linear-gradient(to bottom, #fff 20%, var(--neon-blue) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .controls-list {
            text-align: left; font-size: 9px; line-height: 2; color: #fff;
            margin: 20px 0; padding: 15px; border: 1px dashed var(--neon-blue);
        }

        button.main-btn {
            padding: 20px 40px; font-family: 'Press Start 2P';
            font-size: 16px; background: var(--neon-blue); border: none; color: #000;
            cursor: pointer; transition: 0.2s; box-shadow: 6px 6px 0 var(--neon-pink);
        }
        button.main-btn:hover { transform: translate(-2px, -2px); box-shadow: 8px 8px 0 var(--neon-pink); background: #fff; }

        #ui { position: absolute; top: 20px; left: 20px; color: var(--neon-blue); z-index: 100; pointer-events: none; }
        .stat-line { margin-bottom: 12px; font-size: 10px; text-shadow: 2px 2px #000; }
        .best-label { font-size: 8px; color: var(--neon-yellow); display: block; margin-top: 2px; opacity: 0.8; }
        
        #stamina-bar { width: 180px; height: 10px; border: 2px solid var(--neon-blue); background: rgba(0,0,0,0.5); margin-top: 10px; }
        #stamina-fill { width: 100%; height: 100%; background: var(--neon-blue); }

        #joystick-wrapper {
            position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px;
            background: rgba(255,255,255,0.1); border: 2px solid var(--neon-blue);
            border-radius: 50%; display: none; z-index: 2000; touch-action: none;
        }
        #joystick-knob {
            position: absolute; top: 35px; left: 35px; width: 50px; height: 50px;
            background: var(--neon-blue); border-radius: 50%; box-shadow: 0 0 15px var(--neon-blue);
        }
        #mobile-btns {
            position: absolute; bottom: 40px; right: 40px; display: none; gap: 20px; z-index: 2000;
        }
        .m-btn {
            width: 70px; height: 70px; border: 2px solid var(--neon-pink); border-radius: 50%;
            background: rgba(255,0,85,0.2); color: white; display: flex; 
            justify-content: center; align-items: center; font-size: 8px; touch-action: none;
        }

        .yellow { color: var(--neon-yellow); }
        .pink { color: var(--neon-pink); }
        #final-stats { color: #fff; font-size: 10px; line-height: 2.2; margin: 20px 0; text-align: left; }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="menu-card">
            <div class="lang-btns">
                <button class="lang-btn active" id="btn-ru">RU</button>
                <button class="lang-btn" id="btn-en">EN</button>
            </div>
            <h1>BYTERUSH</h1>
            <div class="controls-list" id="controls-text"></div>
            <button id="start-btn" class="main-btn">BOOT_SYSTEM</button>
        </div>
    </div>

    <div id="pause-screen" style="display: none;">
        <div class="menu-card">
            <h1 id="pause-title">PAUSED</h1>
            <button id="resume-btn" class="main-btn">PROCEED</button>
        </div>
    </div>

    <div id="death-screen" style="display: none;">
        <div class="menu-card" style="border-color: var(--neon-pink);">
            <h1 id="death-title" style="color: var(--neon-pink);">SYSTEM_CRASH</h1>
            <div id="final-stats"></div>
            <button id="restart-btn" class="main-btn">REBOOT</button>
        </div>
    </div>

    <div id="ui">
        <div class="stat-line"><span id="score-box">CORES: 0</span><span class="best-label" id="best-score-ui">BEST: 0</span></div>
        <div class="stat-line"><span id="dist-box">DIST: 0m</span><span class="best-label" id="best-dist-ui">BEST: 0m</span></div>
        <div class="stat-line"><span id="kill-box">KILLS: 0</span><span class="best-label" id="best-kills-ui">BEST: 0</span></div>
        <div id="stamina-bar"><div id="stamina-fill"></div></div>
    </div>

    <div id="joystick-wrapper"><div id="joystick-knob"></div></div>
    <div id="mobile-btns">
        <div class="m-btn" id="m-jump">JUMP</div>
        <div class="m-btn" id="m-atk" style="border-color: var(--neon-blue); background: rgba(0,240,255,0.2);">ATK</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/PointerLockControls.js"></script>

<script>
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    const i18n = {
        ru: {
            ctrl: isTouch ? `> ДЖОЙСТИК: <span class="yellow">ДВИЖЕНИЕ</span><br>> ЭКРАН СПРАВА: <span class="yellow">ОБЗОР</span><br>> КНОПКИ: <span class="pink">ПРЫЖОК И УДАР</span><br>> СТЕНЫ: <span class="yellow">АВТО-БЕГ</span>` : 
                 `> WASD: <span class="yellow">ДВИЖЕНИЕ</span><br>> SHIFT: <span class="yellow">СПРИНТ (ДЭШ)</span><br>> ПКМ + SHIFT: <span class="yellow">БЕГ ПО СТЕНЕ</span><br>> ПРОБЕЛ: <span class="pink">ПРЫЖОК / ОТСКОК</span><br>> ЛКМ: <span class="pink">УДАР ПО ВИРУСУ</span>`,
            boot: "ЗАПУСК_СИСТЕМЫ", pause: "ПАУЗА", proceed: "ПРОДОЛЖИТЬ", crash: "СБОЙ_СИСТЕМЫ", reboot: "ПЕРЕЗАГРУЗКА", 
            ui_score: "ЯДРА", ui_dist: "ДИСТ", ui_kills: "ВИРУСЫ", ui_best: "РЕКОРД",
            new_rec: " (НОВЫЙ!)"
        },
        en: {
            ctrl: isTouch ? `> JOYSTICK: <span class="yellow">MOVEMENT</span><br>> RIGHT SCREEN: <span class="yellow">LOOK</span><br>> BUTTONS: <span class="pink">JUMP & STRIKE</span><br>> WALLS: <span class="yellow">AUTO WALL-RUN</span>` :
                 `> WASD: <span class="yellow">MOVEMENT</span><br>> SHIFT: <span class="yellow">SPRINT (DASH)</span><br>> RMB + SHIFT: <span class="yellow">WALL_RUN</span><br>> SPACE: <span class="pink">JUMP / WALL_JUMP</span><br>> LEFT_CLICK: <span class="pink">STRIKE VIRUS</span>`,
            boot: "BOOT_SYSTEM", pause: "PAUSED", proceed: "PROCEED", crash: "SYSTEM_CRASH", reboot: "REBOOT", 
            ui_score: "CORES", ui_dist: "DIST", ui_kills: "KILLS", ui_best: "BEST",
            new_rec: " (NEW!)"
        }
    };
    let currentLang = 'ru';
    function updateLang(lang) {
        currentLang = lang;
        const t = i18n[lang];
        document.getElementById('controls-text').innerHTML = t.ctrl;
        document.getElementById('start-btn').innerText = t.boot;
        document.getElementById('pause-title').innerText = t.pause;
        document.getElementById('resume-btn').innerText = t.proceed;
        document.getElementById('death-title').innerText = t.crash;
        document.getElementById('restart-btn').innerText = t.reboot;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.id.includes(lang)));
    }
    document.getElementById('btn-ru').onclick = () => updateLang('ru');
    document.getElementById('btn-en').onclick = () => updateLang('en');
    updateLang('ru');

    let records = {
        score: parseInt(localStorage.getItem('br_best_score') || '0'),
        dist: parseInt(localStorage.getItem('br_best_dist') || '0'),
        kills: parseInt(localStorage.getItem('br_best_kills') || '0')
    };

    const bgMusic = new Audio();
    const playlist = ['ByteRush1.mp3', 'ByteRush2.mp3'];
    let trackIdx = parseInt(localStorage.getItem('lastTrackIdx') || '0');

    function playMusic() {
        bgMusic.src = playlist[trackIdx];
        bgMusic.volume = 0.5;
        bgMusic.play().catch(() => {});
        localStorage.setItem('lastTrackIdx', (trackIdx + 1) % playlist.length);
        bgMusic.onended = () => { trackIdx = (trackIdx + 1) % playlist.length; playMusic(); };
    }

    function createCircuitTexture(renderer) {
        const size = 512; // Меньше размер текстуры для мобилок
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#020205'; ctx.fillRect(0, 0, size, size);
        ctx.strokeStyle = '#080812'; ctx.lineWidth = 2;
        for(let i=0; i<=size; i+=64) {
            ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, size); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(size, i); ctx.stroke();
        }
        ctx.strokeStyle = '#00f0ff'; ctx.lineWidth = 1; ctx.globalAlpha = 0.3;
        for(let i=0; i<8; i++) {
            let x = Math.floor(Math.random() * 8) * 64;
            let y = Math.floor(Math.random() * 8) * 64;
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + 64, y); ctx.lineTo(x + 64, y + 64); ctx.stroke();
        }
        const texture = new THREE.CanvasTexture(canvas);
        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
        return texture;
    }

    window.onload = function() {
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x010103);
        scene.fog = new THREE.Fog(0x010103, 10, 100);

        const cameraHolder = new THREE.Group();
        cameraHolder.position.y = 2.2; 
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        cameraHolder.add(camera);
        scene.add(cameraHolder);

        const renderer = new THREE.WebGLRenderer({ antialias: !isTouch });
        renderer.setSize(window.innerWidth, window.innerHeight);
        // ОПТИМИЗАЦИЯ: Лимит разрешения
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.3)); 
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.PointerLockControls(cameraHolder, document.body);
        let gameActive = false;

        document.getElementById('start-btn').onclick = () => { 
            if(!isTouch) controls.lock(); 
            else { startGameMobile(); }
            playMusic(); 
        };
        document.getElementById('resume-btn').onclick = () => { if(!isTouch) controls.lock(); else startGameMobile(); };
        document.getElementById('restart-btn').onclick = () => location.reload();

        function startGameMobile() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('pause-screen').style.display = 'none';
            document.getElementById('joystick-wrapper').style.display = 'block';
            document.getElementById('mobile-btns').style.display = 'flex';
            gameActive = true;
        }

        controls.addEventListener('lock', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('pause-screen').style.display = 'none';
            gameActive = true;
        });
        controls.addEventListener('unlock', () => {
            if (document.getElementById('death-screen').style.display !== 'flex') {
                document.getElementById('pause-screen').style.display = 'flex';
                gameActive = false;
            }
        });

        const chipTexture = createCircuitTexture(renderer);
        const wallMaterial = new THREE.MeshStandardMaterial({ map: chipTexture, roughness: 1.0 });
        const floorMaterial = new THREE.MeshStandardMaterial({ map: chipTexture, roughness: 1.0 });

        const handGroup = new THREE.Group();
        camera.add(handGroup);
        let isAttacking = false;

        function createBlade(x) {
            const h = new THREE.Group();
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.12, 0.4), new THREE.MeshBasicMaterial({color: 0x000000}));
            const blade = new THREE.Mesh(new THREE.BoxGeometry(0.02, 0.1, 1.4), new THREE.MeshStandardMaterial({color: 0x00f0ff, emissive: 0x00f0ff, emissiveIntensity: 2}));
            blade.position.z = -0.7; h.add(arm, blade); h.position.set(0.75 * x, -0.5, -0.4);
            return h;
        }
        const leftH = createBlade(-1); const rightH = createBlade(1);
        handGroup.add(leftH, rightH);

        let wallObjects = [], floorObjects = [], hazardObjects = [], coins = [], lamps = [];
        let score = 0, kills = 0, distance = 0, lastZ = 0;

        function removeObject(obj, array) {
            scene.remove(obj);
            if (obj.geometry) obj.geometry.dispose();
            if (obj.material) {
                if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
                else obj.material.dispose();
            }
            const idx = array.indexOf(obj);
            if (idx > -1) array.splice(idx, 1);
        }

        function cleanup(playerZ) {
            const threshold = playerZ + 40; 
            [floorObjects, wallObjects, coins, hazardObjects].forEach(arr => {
                for (let i = arr.length - 1; i >= 0; i--) {
                    if (arr[i].position.z > threshold) removeObject(arr[i], arr);
                }
            });
            for (let i = lamps.length - 1; i >= 0; i--) {
                if (lamps[i].mesh.position.z > threshold) {
                    scene.remove(lamps[i].light); removeObject(lamps[i].mesh, []);
                    lamps.splice(i, 1);
                }
            }
        }

        function generateChunk(z) {
            const isSafe = z > -60;
            const rand = Math.random();
            if (isSafe || rand > 0.25) {
                let w = isSafe ? 16 : (rand > 0.8 ? 8 : 14); 
                let xPos = isSafe ? 0 : (rand > 0.8 ? (Math.random() > 0.5 ? 4 : -4) : 0);
                const f = new THREE.Mesh(new THREE.BoxGeometry(w, 1, 10.1), floorMaterial);
                f.position.set(xPos, -1, z); scene.add(f); floorObjects.push(f);
                const ceil = new THREE.Mesh(new THREE.BoxGeometry(w, 1, 10.1), floorMaterial);
                ceil.position.set(xPos, 12, z); scene.add(ceil); floorObjects.push(ceil);
            }
            [-8, 8].forEach(x => {
                const w = new THREE.Mesh(new THREE.BoxGeometry(1.5, 25, 10), wallMaterial);
                w.position.set(x, 10, z); scene.add(w); wallObjects.push(w);
                if (Math.abs(z) % 20 === 0) {
                    const l = new THREE.Mesh(new THREE.BoxGeometry(0.5, 4, 0.12), new THREE.MeshStandardMaterial({emissive: 0x00f0ff, emissiveIntensity: 4}));
                    l.position.set(x > 0 ? 7.2 : -7.2, 5, z); scene.add(l);
                    const pl = new THREE.PointLight(0x00f0ff, 1.5, 20); pl.position.copy(l.position); scene.add(pl);
                    lamps.push({ mesh: l, light: pl });
                }
            });
            if (!isSafe) {
                if (Math.random() > 0.5) {
                    const c = new THREE.Mesh(new THREE.IcosahedronGeometry(0.4), new THREE.MeshStandardMaterial({color: 0xffcc00, emissive: 0xffcc00, emissiveIntensity: 1.5}));
                    c.position.set(Math.random()*12-6, 1.5, z); scene.add(c); coins.push(c);
                }
                if (Math.random() > 0.7) {
                    const h = new THREE.Mesh(new THREE.OctahedronGeometry(1.3), new THREE.MeshStandardMaterial({color: 0xff0000, wireframe: true, emissive: 0xff0000, emissiveIntensity: 2}));
                    h.position.set(Math.random()*10-5, 2, z); scene.add(h); hazardObjects.push(h);
                }
            }
        }
        for(let i=0; i<30; i++) { generateChunk(i * -10); lastZ = i * -10; }

        let keys = {}, isRightClick = false, stamina = 100, speedFactor = 1.0;
        const velocity = new THREE.Vector3();
        let canJump = false, wallSide = 0;
        const downRay = new THREE.Raycaster();
        const sideRay = new THREE.Raycaster();

        document.addEventListener('keydown', e => { 
            keys[e.code] = true; 
            if (e.code === 'Space') doJump();
        });
        document.addEventListener('keyup', e => keys[e.code] = false);
        document.addEventListener('mousedown', e => { if(e.button === 0) attack(); if(e.button === 2) isRightClick = true; });
        document.addEventListener('mouseup', e => { if(e.button === 2) isRightClick = false; });
        window.addEventListener('contextmenu', e => e.preventDefault());

        function doJump() {
            if (canJump) { velocity.y = 15; canJump = false; }
            else if (wallSide !== 0) { velocity.y = 16; velocity.x = -wallSide * 22; velocity.z -= 12; wallSide = 0; }
        }

        // --- МОБИЛЬНОЕ УПРАВЛЕНИЕ (ИСПРАВЛЕНО) ---
        let touchData = { active: false, startX: 0, startY: 0, moveX: 0, moveY: 0, lookTouchId: null, lastLookX: 0, lastLookY: 0 };
        const joyKnob = document.getElementById('joystick-knob');
        
        renderer.domElement.addEventListener('touchstart', e => {
            for(let i=0; i<e.changedTouches.length; i++) {
                let t = e.changedTouches[i];
                if (t.clientX < window.innerWidth / 2) { // Левая часть - джойстик
                    touchData.active = true;
                    touchData.startX = t.clientX; touchData.startY = t.clientY;
                } else { // Правая часть - обзор
                    touchData.lookTouchId = t.identifier;
                    touchData.lastLookX = t.clientX; touchData.lastLookY = t.clientY;
                }
            }
        }, {passive: false});

        window.addEventListener('touchmove', e => {
            for(let i=0; i<e.changedTouches.length; i++) {
                let t = e.changedTouches[i];
                if (touchData.active && t.clientX < window.innerWidth / 2) {
                    const dx = t.clientX - touchData.startX;
                    const dy = t.clientY - touchData.startY;
                    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
                    const angle = Math.atan2(dy, dx);
                    touchData.moveX = Math.cos(angle) * (dist / 50);
                    touchData.moveY = Math.sin(angle) * (dist / 50);
                    joyKnob.style.transform = `translate(${touchData.moveX * 50}px, ${touchData.moveY * 50}px)`;
                } else if (t.identifier === touchData.lookTouchId) {
                    const dx = t.clientX - touchData.lastLookX;
                    const dy = t.clientY - touchData.lastLookY;
                    cameraHolder.rotation.y -= dx * 0.006;
                    touchData.lastLookX = t.clientX; touchData.lastLookY = t.clientY;
                }
            }
        }, {passive: false});

        window.addEventListener('touchend', e => {
            for(let i=0; i<e.changedTouches.length; i++) {
                let t = e.changedTouches[i];
                if (t.clientX < window.innerWidth / 2) {
                    touchData.active = false;
                    touchData.moveX = 0; touchData.moveY = 0;
                    joyKnob.style.transform = `translate(0,0)`;
                } else if (t.identifier === touchData.lookTouchId) {
                    touchData.lookTouchId = null;
                }
            }
        });

        document.getElementById('m-jump').addEventListener('touchstart', (e) => { e.preventDefault(); doJump(); });
        document.getElementById('m-atk').addEventListener('touchstart', (e) => { e.preventDefault(); attack(); });

        function attack() {
            if (isAttacking || (!controls.isLocked && !isTouch)) return;
            isAttacking = true;
            const tl = new THREE.Vector3(0, 0, -1.3);
            leftH.position.add(tl); rightH.position.add(tl);
            const attackRay = new THREE.Raycaster(cameraHolder.position, camera.getWorldDirection(new THREE.Vector3()));
            const hits = attackRay.intersectObjects(hazardObjects);
            if (hits.length > 0 && hits[0].distance < 7) {
                scene.remove(hits[0].object); hazardObjects.splice(hazardObjects.indexOf(hits[0].object), 1);
                kills++; 
            }
            setTimeout(() => { leftH.position.sub(tl); rightH.position.sub(tl); isAttacking = false; }, 100);
        }

        let prevTime = performance.now();
        let frameCount = 0;
        function animate() {
            requestAnimationFrame(animate);
            if (!gameActive) return;

            const time = performance.now();
            const delta = Math.min((time - prevTime) / 1000, 0.05);
            prevTime = time;
            frameCount++;

            let isRunning = keys['ShiftLeft'] || (isTouch && Math.abs(touchData.moveY) > 0.8);
            if (isRunning && (keys['KeyW'] || touchData.active) && stamina > 0) {
                speedFactor = THREE.MathUtils.lerp(speedFactor, 2.4, 0.1); stamina -= 38 * delta;
            } else {
                speedFactor = THREE.MathUtils.lerp(speedFactor, 1.0, 0.2); if (stamina < 100) stamina += 28 * delta;
            }
            document.getElementById('stamina-fill').style.width = Math.max(0, stamina) + '%';

            velocity.x -= velocity.x * 10.0 * delta; velocity.z -= velocity.z * 10.0 * delta; velocity.y -= 38.0 * delta;
            const moveStep = 220.0 * delta * speedFactor;

            if (keys['KeyW']) velocity.z -= moveStep; if (keys['KeyS']) velocity.z += moveStep;
            if (keys['KeyA']) velocity.x -= moveStep; if (keys['KeyD']) velocity.x += moveStep;
            
            if (isTouch && touchData.active) {
                velocity.z += touchData.moveY * moveStep;
                velocity.x += touchData.moveX * moveStep;
            }

            wallSide = 0;
            const isWallRunKey = isRightClick || isTouch;
            if (isWallRunKey && !canJump && stamina > 5) {
                const dirs = [new THREE.Vector3(1,0,0), new THREE.Vector3(-1,0,0)];
                dirs.forEach((d, i) => {
                    const rayDir = d.clone().applyQuaternion(cameraHolder.quaternion);
                    sideRay.set(cameraHolder.position, rayDir);
                    const hits = sideRay.intersectObjects(wallObjects);
                    if (hits.length > 0 && hits[0].distance < 3) wallSide = (i === 0 ? 1 : -1);
                });
            }
            if (wallSide !== 0) {
                velocity.y = 0; velocity.z -= 75 * delta;
                camera.rotation.z = THREE.MathUtils.lerp(camera.rotation.z, 0.35 * wallSide, 0.1);
            } else { camera.rotation.z = THREE.MathUtils.lerp(camera.rotation.z, 0, 0.1); }

            if (!isTouch) {
                controls.moveRight(velocity.x * delta); controls.moveForward(-velocity.z * delta);
            } else {
                cameraHolder.translateX(velocity.x * delta);
                cameraHolder.translateZ(velocity.z * delta);
            }
            
            cameraHolder.position.y += velocity.y * delta;
            if (cameraHolder.position.y > 10.5) { cameraHolder.position.y = 10.5; velocity.y = 0; }

            wallObjects.forEach(w => {
                const dx = cameraHolder.position.x - w.position.x;
                const dz = Math.abs(cameraHolder.position.z - w.position.z);
                if (dz < 5 && Math.abs(dx) < 2.3) { cameraHolder.position.x = w.position.x + (dx > 0 ? 2.3 : -2.3); }
            });

            downRay.set(cameraHolder.position, new THREE.Vector3(0,-1,0));
            const fHits = downRay.intersectObjects(floorObjects);
            if (fHits.length > 0 && fHits[0].distance < 2.3) {
                if (velocity.y < 0) { cameraHolder.position.y = fHits[0].point.y + 2.2; velocity.y = 0; canJump = true; }
            } else canJump = false;

            distance = Math.floor(Math.abs(cameraHolder.position.z));
            coins.forEach((c, idx) => {
                c.rotation.y += 0.12;
                if (cameraHolder.position.distanceTo(c.position) < 2.3) { scene.remove(c); coins.splice(idx, 1); score += 1; }
            });

            if (hazardObjects.some(h => cameraHolder.position.distanceTo(h.position) < 2.2) || cameraHolder.position.y < -15) {
                gameActive = false;
                if(!isTouch) controls.unlock();
                const isNewS = score > records.score;
                const isNewD = distance > records.dist;
                const isNewK = kills > records.kills;
                if (isNewS) { records.score = score; localStorage.setItem('br_best_score', score); }
                if (isNewD) { records.dist = distance; localStorage.setItem('br_best_dist', distance); }
                if (isNewK) { records.kills = kills; localStorage.setItem('br_best_kills', kills); }
                document.getElementById('death-screen').style.display = 'flex';
                document.getElementById('joystick-wrapper').style.display = 'none';
                document.getElementById('mobile-btns').style.display = 'none';
                const t = i18n[currentLang];
                document.getElementById('final-stats').innerHTML = `
                    <div class="${isNewD?'yellow':'pink'}">> ${t.ui_dist}: ${distance}m ${isNewD?t.new_rec:''}</div>
                    <div class="${isNewS?'yellow':'pink'}">> ${t.ui_score}: ${score} ${isNewS?t.new_rec:''}</div>
                    <div class="${isNewK?'yellow':'pink'}">> ${t.ui_kills}: ${kills} ${isNewK?t.new_rec:''}</div>
                `;
            }

            if (cameraHolder.position.z < lastZ + 120) { 
                lastZ -= 10; generateChunk(lastZ); cleanup(cameraHolder.position.z); 
            }

            // ОПТИМИЗАЦИЯ: Обновление цвета ламп реже
            if (frameCount % 2 === 0) {
                const hue = (time * 0.0002) % 1; 
                const color = new THREE.Color().setHSL(hue, 0.9, 0.6);
                lamps.forEach(l => { if(l.mesh.material) l.mesh.material.emissive.copy(color); l.light.color.copy(color); });
            }
            
            if (!isAttacking) handGroup.position.y = Math.sin(time * 0.005) * 0.02 + (velocity.z !== 0 ? Math.sin(time * 0.01)*0.04 : 0);

            const t = i18n[currentLang];
            document.getElementById('dist-box').innerText = `${t.ui_dist}: ${distance}m`;
            document.getElementById('score-box').innerText = `${t.ui_score}: ${score}`;
            document.getElementById('kill-box').innerText = `${t.ui_kills}: ${kills}`;
            document.getElementById('best-dist-ui').innerText = `${t.ui_best}: ${records.dist}m`;
            document.getElementById('best-score-ui').innerText = `${t.ui_best}: ${records.score}`;
            document.getElementById('best-kills-ui').innerText = `${t.ui_best}: ${records.kills}`;

            renderer.render(scene, camera);
        }
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        animate();
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    };
</script>
</body>
</html>
